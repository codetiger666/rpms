name: update-version
on: 
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  update-version:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: git init
        run: |
          git config --global user.email ${{ secrets.email }}
          git config --global user.name "codetiger666"
          git config pull.rebase false
      
      - name: get new version
        run: |
          source init/common.sh
          while IFS= read -r line || [[ -n "$line" ]]; do
            # ä½¿ç”¨ '=' åˆ†éš”è¡Œ
            IFS='=' read -r program version repo location handle new <<< "$line"
            # åŽ»é™¤ key å’Œ value ä¸¤è¾¹çš„ç©ºç™½ï¼ˆå¯é€‰ï¼‰
            program=$(echo "$program" | xargs)
            version=$(echo "$version" | xargs)
            new_version=
            pkgVersion=$(apply_handle "$handle" "$new_version")
            if [[ -z "$program" || -z "$version" || -z "$repo" ]]; then
              # å¦‚æžœä»»æ„ä¸€ä¸ªå˜é‡ä¸ºç©ºï¼Œè·³è¿‡å½“å‰å¾ªçŽ¯è¿­ä»£
              continue
            fi
            new_version=$(get_latest_version "$location" "$repo")
            temp_version=$new_version
            new_version=$(apply_handle "$handle" "$new_version" "$new")
            echo -e "\n$programèŽ·å–åˆ°çš„æœ€æ–°ç‰ˆæœ¬${new_version}"
            if [ "$version" = "$new_version" ]; then
                echo "$programæœ€æ–°ç‰ˆæœ¬å·²ç»ç¼–è¯‘è¿‡"
                curl -X POST \
                --url https://api.telegram.org/bot${{ secrets.TG_BOT_KEY }}/sendMessage \
                --header 'Accept: */*' \
                --header 'Accept-Encoding: gzip, deflate, br' \
                --header 'Connection: keep-alive' \
                --header 'Content-Type: application/json' \
                --data "{
                \"chat_id\": \"${{ secrets.TG_BOT_USER_ID }}\",
                \"text\": \"\\\\[${program//-/\\\\-}\\\\] \\\\[â­• å·²ç»ç¼–è¯‘å®Œæˆ\\\\]\nç‰ˆæœ¬:\`${new_version//./\\\\.}\`\",
                \"parse_mode\": \"MarkdownV2\",
                \"reply_markup\": {
                    \"inline_keyboard\": [
                        [
                                {
                                    \"text\": \"${program} $new_versionæ›´æ–°æ—¥å¿—\",
                                    \"url\": \"https://github.com/$repo/releases/tag/$temp_version\"
                                }
                        ]
                    ]
                }
                }"
                sleep 60
                continue
            else
              run_workflow=$(curl https://api.github.com/repos/codetiger666/rpms/actions/runs | jq '.workflow_runs[] | select(.name == "release")' | jq 'select(.status == "queued" or .status == "in_progress")')
              while true; do
                # å¦‚æžœå˜é‡ a ä¸ºç©ºï¼Œè·³è¿‡å½“å‰å¾ªçŽ¯
                if [ -z "$run_workflow" ]; then
                  break
                fi
                echo "å½“å‰æœ‰ç¼–è¯‘ä»»åŠ¡è¿›è¡Œä¸­ï¼Œç­‰å¾…30såŽé‡è¯•"
                sleep 30
                run_workflow=$(curl https://api.github.com/repos/codetiger666/rpms/actions/runs | jq '.workflow_runs[] | select(.name == "release")' | jq 'select(.status == "queued" or .status == "in_progress")')
              done
              # æ›¿æ¢ç‰ˆæœ¬
              sed -i "s/$program=$version/$program=$new_version/" version
              git pull
              git add .
              git commit -m "chore: $program bump version to $new_version"
              git push
              curl -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/release.yml/dispatches \
              -d "{\"ref\":\"main\",\"inputs\":{\"program\":\"$program\",\"version\":\"$new_version\",\"release\":\"9\",\"remove\":\"false\",\"ssh\":\"false\"}}"
              echo "$programè§¦å‘ç¼–è¯‘ç‰ˆæœ¬:${new_version}"
              curl -X POST \
              --url https://api.telegram.org/bot${{ secrets.TG_BOT_KEY }}/sendMessage \
              --header 'Accept: */*' \
              --header 'Accept-Encoding: gzip, deflate, br' \
              --header 'Connection: keep-alive' \
              --header 'Content-Type: application/json' \
              --data "{
              \"chat_id\": \"${{ secrets.TG_BOT_USER_ID }}\",
              \"text\": \"\\\\[${program//-/\\\\-}\\\\] \\\\[ðŸŸ¢ è§¦å‘ç¼–è¯‘\\\\]\nç‰ˆæœ¬ï¼š\`${new_version//./\\\\.}\`\",
              \"parse_mode\": \"MarkdownV2\",
              \"reply_markup\": {
                  \"inline_keyboard\": [
                      [
                              {
                                  \"text\": \"${program}$new_versionæ›´æ–°æ—¥å¿—\",
                                  \"url\": \"https://github.com/$repo/releases/tag/$temp_version\"
                              }
                      ]
                  ]
              }
              }"
              sleep 60
            fi
          done < version

      - name: Remove workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 3
